name: Lint specifications and check Backward Compatibility

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: false
        default: 'warning'
        type: choice
        options:
          - info
          - warning
          - debug
jobs:
   run-lint:
     runs-on: ubuntu-latest
     steps:
       - name: Checkout code
         uses: actions/checkout@v4
         with:
           fetch-depth: 0

       - name: Set up Node.js
         uses: actions/setup-node@v3
         with:
           node-version: '14'

       - name: Install OpenAPI linter
         run: npm install -g @stoplight/spectral-cli

       - name: Lint OpenAPI specs
         run: spectral lint **/*.yaml

       - name: Run OpenAPI Examples validation check
         run: |
          docker run -v "$(pwd):/central-contract-repo:rw" \
            --env-file env.list \
            --entrypoint /bin/sh znsio/specmatic \
            -c "git config --global --add safe.directory /central-contract-repo && cd /central-contract-repo && java -jar /usr/src/app/specmatic.jar examples validate --contract-file=orders/product_search_bff_v4.yaml"
